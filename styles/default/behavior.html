<!DOCTYPE html><html lang="en"><head><title>styles/default/behavior</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="styles/default/behavior"><meta name="groc-project-path" content="lib/styles/default/behavior.coffee"><meta name="groc-github-url" content="https://github.com/nevir/groc"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path"><a href="https://github.com/nevir/groc/blob/master/lib/styles/default/behavior.coffee">lib/styles/default/behavior.coffee</a></div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">tableOfContents = </span><span class="o">&lt;%=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">tableOfContents</span><span class="p">)</span> <span class="o">%&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h1 id="page-behavior">Page Behavior</h1></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="table-of-contents">Table of Contents</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Global jQuery references to navigation components we care about.</p></div></div><div class="code"><div class="wrapper"><span class="nv">nav$ = </span><span class="kc">null</span>
<span class="nv">toc$ = </span><span class="kc">null</span>

<span class="nv">setTableOfContentsActive = </span><span class="nf">(active) -&gt;</span>
  <span class="nv">html$ = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;html&#39;</span><span class="p">)</span>

  <span class="k">if</span> <span class="nx">active</span>
    <span class="nx">nav$</span><span class="p">.</span><span class="nx">addClass</span>  <span class="s">&#39;active&#39;</span>
    <span class="nx">html$</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;popped&#39;</span>
  <span class="k">else</span>
    <span class="nx">nav$</span><span class="p">.</span><span class="nx">removeClass</span>  <span class="s">&#39;active&#39;</span>
    <span class="nx">html$</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;popped&#39;</span>

<span class="nv">toggleTableOfContents = </span><span class="nf">-&gt;</span>
  <span class="nx">setTableOfContentsActive</span> <span class="o">not</span> <span class="nx">nav$</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;active&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h3 id="node-navigation">Node Navigation</h3></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="nv">currentNode$ = </span><span class="kc">null</span>

<span class="nv">focusCurrentNode = </span><span class="nf">-&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We use the first child's offset top rather than toc$.offset().top because there may be borders
or other stylistic tweaks that further offset the scrollTop.</p></div></div><div class="code"><div class="wrapper">  <span class="nv">currentNodeTop    = </span><span class="nx">currentNode$</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">toc$</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s">&#39;:visible&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">().</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span>
  <span class="nv">currentNodeBottom = </span><span class="nx">currentNodeTop</span> <span class="o">+</span> <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s">&#39;.label&#39;</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>If the current node is partially or fully above the top of the viewport, scroll it into view.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">currentNodeTop</span> <span class="o">&lt;</span> <span class="nx">toc$</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">()</span>
    <span class="nx">toc$</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="nx">currentNodeTop</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Similarly, if we're below the bottom of the viewport, scroll up enough to make it visible.</p></div></div><div class="code"><div class="wrapper">  <span class="k">if</span> <span class="nx">currentNodeBottom</span> <span class="o">&gt;</span> <span class="nx">toc$</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">toc$</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>
    <span class="nx">toc$</span><span class="p">.</span><span class="nx">scrollTop</span> <span class="nx">currentNodeBottom</span> <span class="o">-</span> <span class="nx">toc$</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span>

<span class="nv">setCurrentNodeExpanded = </span><span class="nf">(expanded) -&gt;</span>
  <span class="k">if</span> <span class="nx">expanded</span>
    <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;expanded&#39;</span>
  <span class="k">else</span>
    <span class="k">if</span> <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;expanded&#39;</span>
      <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;expanded&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We collapse up to the node's parent if the current node is already collapsed.  This allows
a user to quickly spam left to move up the tree.</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span>
      <span class="nv">parents$ = </span><span class="nx">currentNode$</span><span class="p">.</span><span class="nx">parents</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">)</span>
      <span class="nx">selectNode</span> <span class="nx">parents$</span><span class="p">.</span><span class="nx">first</span><span class="p">()</span> <span class="k">if</span> <span class="nx">parents$</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>

  <span class="nx">focusCurrentNode</span><span class="p">()</span>

<span class="nv">selectNode = </span><span class="nf">(newNode$) -&gt;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Remove first, in case it's the same node</p></div></div><div class="code"><div class="wrapper">  <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;selected&#39;</span>
  <span class="nx">newNode$</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;selected&#39;</span>

  <span class="nv">currentNode$ = </span><span class="nx">newNode$</span>
  <span class="nx">focusCurrentNode</span><span class="p">()</span>

<span class="nv">selectNodeByDocumentPath = </span><span class="nf">(documentPath, headerSlug=null) -&gt;</span>
  <span class="nv">currentNode$ = </span><span class="nx">fileMap</span><span class="p">[</span><span class="nx">documentPath</span><span class="p">]</span>
  <span class="k">if</span> <span class="nx">headerSlug</span>
    <span class="k">for</span> <span class="nx">link</span> <span class="k">in</span> <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;.outline a&#39;</span>
      <span class="nv">urlChunks = </span><span class="nx">$</span><span class="p">(</span><span class="nx">link</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">).</span><span class="nx">split</span> <span class="s">&#39;#&#39;</span>

      <span class="k">if</span> <span class="nx">urlChunks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">headerSlug</span>
        <span class="nv">currentNode$ = </span><span class="nx">$</span><span class="p">(</span><span class="nx">link</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">).</span><span class="nx">first</span><span class="p">()</span>
        <span class="k">break</span>

  <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;selected expanded&#39;</span>
  <span class="nx">currentNode$</span><span class="p">.</span><span class="nx">parents</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">).</span><span class="nx">addClass</span> <span class="s">&#39;expanded&#39;</span>

  <span class="nx">focusCurrentNode</span><span class="p">()</span>

<span class="nv">moveCurrentNode = </span><span class="nf">(up) -&gt;</span>
  <span class="nv">visibleNodes$ = </span><span class="nx">toc$</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;li:visible:not(.filtered)&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Fall back to the first node if anything goes wrong</p></div></div><div class="code"><div class="wrapper">  <span class="nv">newIndex = </span><span class="mi">0</span>
  <span class="k">for</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">visibleNodes$</span>
    <span class="k">if</span> <span class="nx">node</span> <span class="o">==</span> <span class="nx">currentNode$</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nv">newIndex = </span><span class="k">if</span> <span class="nx">up</span> <span class="k">then</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">else</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nv">newIndex = </span><span class="mi">0</span> <span class="k">if</span> <span class="nx">newIndex</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="nv">newIndex = </span><span class="nx">visibleNodes$</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">newIndex</span> <span class="o">&gt;</span> <span class="nx">visibleNodes$</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="k">break</span>

  <span class="nx">selectNode</span> <span class="nx">$</span><span class="p">(</span><span class="nx">visibleNodes$</span><span class="p">[</span><span class="nx">newIndex</span><span class="p">])</span>

<span class="nv">visitCurrentNode = </span><span class="nf">-&gt;</span>
  <span class="nv">labelLink$ = </span><span class="nx">currentNode$</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s">&#39;a.label&#39;</span><span class="p">)</span>
  <span class="nb">window</span><span class="p">.</span><span class="nv">location = </span><span class="nx">labelLink$</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;href&#39;</span> <span class="k">if</span> <span class="nx">labelLink$</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="node-search">Node Search</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Only show a filter if it matches this many or fewer nodes</p></div></div><div class="code"><div class="wrapper"><span class="nv">MAX_FILTER_SIZE = </span><span class="mi">10</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>An array of of [search string, node, label text] triples</p></div></div><div class="code"><div class="wrapper"><span class="nv">searchableNodes = </span><span class="p">[]</span>
<span class="nv">appendSearchNode = </span><span class="nf">(node$) -&gt;</span>
  <span class="nv">text$ = </span><span class="nx">node$</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;&gt; .label .text&#39;</span><span class="p">)</span>
  <span class="nx">searchableNodes</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">text$</span><span class="p">.</span><span class="nx">text</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">(),</span> <span class="nx">node$</span><span class="p">,</span> <span class="nx">text$</span><span class="p">]</span>

<span class="nv">currentQuery = </span><span class="s">&#39;&#39;</span>
<span class="nv">searchNodes = </span><span class="nf">(queryString) -&gt;</span>
  <span class="nv">queryString = </span><span class="nx">queryString</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
  <span class="k">return</span> <span class="k">if</span> <span class="nx">queryString</span> <span class="o">==</span> <span class="nx">currentQuery</span>
  <span class="nv">currentQuery = </span><span class="nx">queryString</span>

  <span class="k">return</span> <span class="nx">clearFilter</span><span class="p">()</span> <span class="k">if</span> <span class="nx">queryString</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>

  <span class="nv">matcher  = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/[-[\]{}()*+?.,\\^$|#\s]/</span><span class="p">,</span> <span class="s">&quot;\\$&amp;&quot;</span> <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">queryString</span><span class="p">).</span><span class="nx">join</span> <span class="s">&#39;.*&#39;</span>
  <span class="nv">matched  = </span><span class="p">[]</span>
  <span class="nv">filtered = </span><span class="p">[]</span>

  <span class="k">for</span> <span class="nx">nodeInfo</span> <span class="k">in</span> <span class="nx">searchableNodes</span>
    <span class="k">if</span> <span class="nx">matcher</span><span class="p">.</span><span class="nx">test</span> <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">then</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">push</span> <span class="nx">nodeInfo</span> <span class="k">else</span> <span class="nx">filtered</span><span class="p">.</span><span class="nx">push</span> <span class="nx">nodeInfo</span>

  <span class="k">return</span> <span class="nx">clearFilter</span><span class="p">()</span> <span class="k">if</span> <span class="nx">matched</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">MAX_FILTER_SIZE</span>

  <span class="nx">nav$</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;searching&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Update the DOM</p></div></div><div class="code"><div class="wrapper">  <span class="k">for</span> <span class="nx">nodeInfo</span> <span class="k">in</span> <span class="nx">filtered</span>
    <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">removeClass</span> <span class="s">&#39;matched-child&#39;</span>
    <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">addClass</span> <span class="s">&#39;filtered&#39;</span>
    <span class="nx">clearHighlight</span> <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

  <span class="k">for</span> <span class="nx">nodeInfo</span> <span class="k">in</span> <span class="nx">matched</span>
    <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">removeClass</span> <span class="s">&#39;filtered matched-child&#39;</span>
    <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">addClass</span> <span class="s">&#39;matched&#39;</span>

    <span class="nx">highlightMatch</span> <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nx">queryString</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Filter out our immediate parent</p></div></div><div class="code"><div class="wrapper">    <span class="nx">$</span><span class="p">(</span><span class="nx">p</span><span class="p">).</span><span class="nx">addClass</span> <span class="s">&#39;matched-child&#39;</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">parents</span> <span class="s">&#39;li&#39;</span>

<span class="nv">clearFilter = </span><span class="nf">-&gt;</span>
  <span class="nx">nav$</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;searching&#39;</span>
  <span class="nv">currentQuery = </span><span class="s">&#39;&#39;</span>

  <span class="k">for</span> <span class="nx">nodeInfo</span> <span class="k">in</span> <span class="nx">searchableNodes</span>
    <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">removeClass</span> <span class="s">&#39;filtered matched-child&#39;</span>
    <span class="nx">clearHighlight</span> <span class="nx">nodeInfo</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<span class="nv">highlightMatch = </span><span class="nf">(text$, queryString) -&gt;</span>
  <span class="nv">nodeText  = </span><span class="nx">text$</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span>
  <span class="nv">lowerText = </span><span class="nx">nodeText</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>

  <span class="nv">markedText    = </span><span class="s">&#39;&#39;</span>
  <span class="nv">furthestIndex = </span><span class="mi">0</span>

  <span class="k">for</span> <span class="nx">char</span> <span class="k">in</span> <span class="nx">queryString</span>
    <span class="nv">foundIndex    = </span><span class="nx">lowerText</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">char</span><span class="p">,</span> <span class="nx">furthestIndex</span>
    <span class="nx">markedText</span>   <span class="o">+=</span> <span class="nx">nodeText</span><span class="p">[</span><span class="nx">furthestIndex</span><span class="p">...</span><span class="nx">foundIndex</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;&lt;em&gt;</span><span class="si">#{</span><span class="nx">nodeText</span><span class="p">[</span><span class="nx">foundIndex</span><span class="p">]</span><span class="si">}</span><span class="s">&lt;/em&gt;&quot;</span>
    <span class="nv">furthestIndex = </span><span class="nx">foundIndex</span> <span class="o">+</span> <span class="mi">1</span>

  <span class="nx">text$</span><span class="p">.</span><span class="nx">html</span> <span class="nx">markedText</span> <span class="o">+</span> <span class="nx">nodeText</span><span class="p">[</span><span class="nx">furthestIndex</span><span class="p">...]</span>

<span class="nv">clearHighlight = </span><span class="nf">(text$) -&gt;</span>
  <span class="nx">text$</span><span class="p">.</span><span class="nx">text</span> <span class="nx">text$</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span> <span class="c1"># Strip all tags</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="dom-construction">DOM Construction</h2>

<p>Navigation and the table of contents are entirely managed by us.</p></div></div><div class="code"><div class="wrapper"><span class="nv">fileMap = </span><span class="p">{}</span> <span class="c1"># A map of targetPath -&gt; DOM node</span>

<span class="nv">buildNav = </span><span class="nf">(metaInfo) -&gt;</span>
  <span class="nv">nav$ = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    &lt;nav&gt;</span>
<span class="s">      &lt;ul class=&quot;tools&quot;&gt;</span>
<span class="s">        &lt;li class=&quot;toggle&quot;&gt;Table of Contents&lt;/li&gt;</span>
<span class="s">        &lt;li class=&quot;search&quot;&gt;</span>
<span class="s">          &lt;input id=&quot;search&quot; type=&quot;search&quot; autocomplete=&quot;off&quot;/&gt;</span>
<span class="s">        &lt;/li&gt;</span>
<span class="s">      &lt;/ul&gt;</span>
<span class="s">      &lt;ol class=&quot;toc&quot;/&gt;</span>
<span class="s">      &lt;/div&gt;</span>
<span class="s">    &lt;/nav&gt;</span>
<span class="s">  &quot;&quot;&quot;</span><span class="p">).</span><span class="nx">appendTo</span> <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span>
  <span class="nv">toc$ = </span><span class="nx">nav$</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;.toc&#39;</span>

  <span class="k">if</span> <span class="nx">metaInfo</span><span class="p">.</span><span class="nx">githubURL</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Special case the index to go to the project root</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">metaInfo</span><span class="p">.</span><span class="nx">documentPath</span> <span class="o">==</span> <span class="s">&#39;index&#39;</span>
      <span class="nv">sourceURL = </span><span class="nx">metaInfo</span><span class="p">.</span><span class="nx">githubURL</span>
    <span class="k">else</span>
      <span class="nv">sourceURL = </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">metaInfo</span><span class="p">.</span><span class="nx">githubURL</span><span class="si">}</span><span class="s">/blob/master/</span><span class="si">#{</span><span class="nx">metaInfo</span><span class="p">.</span><span class="nx">projectPath</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nx">nav$</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.tools&#39;</span><span class="p">).</span><span class="nx">prepend</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">      &lt;li class=&quot;github&quot;&gt;</span>
<span class="s">        &lt;a href=&quot;</span><span class="si">#{</span><span class="nx">sourceURL</span><span class="si">}</span><span class="s">&quot; title=&quot;View source on GitHub&quot;&gt;</span>
<span class="s">          View source on GitHub</span>
<span class="s">        &lt;/a&gt;</span>
<span class="s">      &lt;/li&gt;</span>
<span class="s">    &quot;&quot;&quot;</span>

  <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">tableOfContents</span>
    <span class="nx">toc$</span><span class="p">.</span><span class="nx">append</span> <span class="nx">buildTOCNode</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">metaInfo</span>

  <span class="nx">nav$</span>

<span class="nv">buildTOCNode = </span><span class="nf">(node, metaInfo) -&gt;</span>
  <span class="nv">node$ = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&quot;&quot;&lt;li class=&quot;</span><span class="si">#{</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span><span class="si">}</span><span class="s">&quot;/&gt;&quot;&quot;&quot;</span><span class="p">)</span>

  <span class="c1">#} just to clarify: we use it in the `clickLabel`-method below, but can</span>
  <span class="c1">#} reference the first time after initializing it a few more lines below</span>
  <span class="nv">discloser = </span><span class="kc">null</span>

  <span class="k">switch</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span>
    <span class="k">when</span> <span class="s">&#39;file&#39;</span>
      <span class="c1">#} Single line to avoid extra whitespace</span>
      <span class="nx">node$</span><span class="p">.</span><span class="nx">append</span> <span class="s">&quot;&quot;&quot;&lt;a class=&quot;label&quot; href=&quot;</span><span class="si">#{</span><span class="nx">metaInfo</span><span class="p">.</span><span class="nx">relativeRoot</span><span class="si">}#{</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">targetPath</span><span class="si">}</span><span class="s">.html&quot; title=&quot;</span><span class="si">#{</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">projectPath</span><span class="si">}</span><span class="s">&quot;&gt;&lt;span class=&quot;text&quot;&gt;</span><span class="si">#{</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="s">&lt;/span&gt;&lt;/a&gt;&quot;&quot;&quot;</span>
      <span class="nv">clickLabel = </span><span class="nf">(evt) -&gt;</span>
        <span class="k">if</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span> <span class="o">is</span> <span class="nx">discloser</span>
          <span class="nx">node$</span><span class="p">.</span><span class="nx">toggleClass</span> <span class="s">&#39;expanded&#39;</span>
          <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
          <span class="k">return</span> <span class="kc">false</span>
        <span class="nx">selectNode</span> <span class="nx">node$</span>

    <span class="k">when</span> <span class="s">&#39;folder&#39;</span>
      <span class="nx">node$</span><span class="p">.</span><span class="nx">append</span> <span class="s">&quot;&quot;&quot;&lt;a class=&quot;label&quot; href=&quot;</span><span class="err">#</span><span class="s">&quot;&gt;&lt;span class=&quot;text&quot;&gt;</span><span class="si">#{</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="s">&lt;/span&gt;&lt;/a&gt;&quot;&quot;&quot;</span>
      <span class="nv">clickLabel = </span><span class="nf">(evt) -&gt;</span>
        <span class="nx">selectNode</span> <span class="nx">node$</span>
        <span class="nx">node$</span><span class="p">.</span><span class="nx">toggleClass</span> <span class="s">&#39;expanded&#39;</span>
        <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">false</span>

  <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="nv">children$ = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;&lt;ol class=&quot;children&quot;/&gt;&#39;</span><span class="p">)</span>
    <span class="nx">children$</span><span class="p">.</span><span class="nx">append</span> <span class="nx">buildTOCNode</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">metaInfo</span> <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span>

    <span class="nx">node$</span><span class="p">.</span><span class="nx">append</span> <span class="nx">children$</span>

  <span class="nv">label$ = </span><span class="nx">node$</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;&gt; .label&#39;</span><span class="p">)</span>
  <span class="nx">label$</span><span class="p">.</span><span class="nx">click</span> <span class="nx">clickLabel</span>

  <span class="nv">discloser$ = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;&lt;span class=&quot;discloser&quot;/&gt;&#39;</span><span class="p">).</span><span class="nx">prependTo</span> <span class="nx">label$</span>
  <span class="nx">discloser$</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;placeholder&#39;</span> <span class="k">unless</span> <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
  <span class="nv">discloser = </span><span class="nx">discloser$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Persist our references to the node</p></div></div><div class="code"><div class="wrapper">  <span class="nx">fileMap</span><span class="p">[</span><span class="nx">node</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">targetPath</span><span class="p">]</span> <span class="o">=</span> <span class="nx">node$</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="s">&#39;file&#39;</span>
  <span class="nx">appendSearchNode</span> <span class="nx">node$</span>

  <span class="nx">node$</span>

<span class="nx">$</span> <span class="nf">-&gt;</span>
  <span class="nv">metaInfo =</span>
    <span class="nv">relativeRoot: </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;meta[name=&quot;groc-relative-root&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>
    <span class="nv">githubURL: </span>   <span class="nx">$</span><span class="p">(</span><span class="s">&#39;meta[name=&quot;groc-github-url&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>
    <span class="nv">documentPath: </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;meta[name=&quot;groc-document-path&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>
    <span class="nv">projectPath: </span> <span class="nx">$</span><span class="p">(</span><span class="s">&#39;meta[name=&quot;groc-project-path&quot;]&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;content&#39;</span><span class="p">)</span>

  <span class="nv">nav$    = </span><span class="nx">buildNav</span> <span class="nx">metaInfo</span>
  <span class="nv">toc$    = </span><span class="nx">nav$</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;.toc&#39;</span>
  <span class="nv">search$ = </span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;#search&#39;</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Select the current file, and expand up to it</p></div></div><div class="code"><div class="wrapper">  <span class="nx">selectNodeByDocumentPath</span> <span class="nx">metaInfo</span><span class="p">.</span><span class="nx">documentPath</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">replace</span> <span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>We use the search box's focus state to toggle the table of contents.  This ensures that search
will always be focused while the toc is up, and that it goes away once the user clicks off.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">search$</span><span class="p">.</span><span class="nx">focus</span> <span class="nf">-&gt;</span> <span class="nx">setTableOfContentsActive</span> <span class="kc">true</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>However, we don't want to hide the table of contents if you are clicking around in the nav.
The blur event doesn't give us the previous event, sadly, so we first trap mousedown events</p></div></div><div class="code"><div class="wrapper">  <span class="nv">lastMousedownTimestamp = </span><span class="kc">null</span>
  <span class="nx">nav$</span><span class="p">.</span><span class="nx">mousedown</span> <span class="nf">(evt) -&gt;</span>
    <span class="nv">lastMousedownTimestamp = </span><span class="nx">evt</span><span class="p">.</span><span class="nx">timeStamp</span> <span class="k">unless</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">target</span> <span class="o">==</span> <span class="nx">toggle$</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>And we refocus search if we are within a very short duration between the last mousedown in nav$.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">search$</span><span class="p">.</span><span class="nx">blur</span> <span class="nf">(evt) -&gt;</span>
    <span class="k">if</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">timeStamp</span> <span class="o">-</span> <span class="nx">lastMousedownTimestamp</span> <span class="o">&lt;</span> <span class="mi">10</span>
      <span class="nx">search$</span><span class="p">.</span><span class="nx">focus</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nx">setTableOfContentsActive</span> <span class="kc">false</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Set up the table of contents toggle</p></div></div><div class="code"><div class="wrapper">  <span class="nv">toggle$ = </span><span class="nx">nav$</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;.toggle&#39;</span>
  <span class="nx">toggle$</span><span class="p">.</span><span class="nx">click</span> <span class="nf">(evt) -&gt;</span>
    <span class="k">if</span> <span class="nx">search$</span><span class="p">.</span><span class="o">is</span> <span class="s">&#39;:focus&#39;</span> <span class="k">then</span> <span class="nx">search$</span><span class="p">.</span><span class="nx">blur</span><span class="p">()</span> <span class="k">else</span> <span class="nx">search$</span><span class="p">.</span><span class="nx">focus</span><span class="p">()</span>
    <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Prevent text selection if the user taps quickly</p></div></div><div class="code"><div class="wrapper">  <span class="nx">toggle$</span><span class="p">.</span><span class="nx">mousedown</span> <span class="nf">(evt) -&gt;</span>
    <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Arrow keys navigate the table of contents whenever it is visible</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">).</span><span class="nx">keydown</span> <span class="nf">(evt) -&gt;</span>
    <span class="k">if</span> <span class="nx">nav$</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;active&#39;</span>
      <span class="k">switch</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">keyCode</span>
        <span class="k">when</span> <span class="mi">13</span> <span class="k">then</span> <span class="nx">visitCurrentNode</span><span class="p">()</span> <span class="c1"># return</span>
        <span class="k">when</span> <span class="mi">37</span> <span class="k">then</span> <span class="nx">setCurrentNodeExpanded</span> <span class="kc">false</span> <span class="c1"># left</span>
        <span class="k">when</span> <span class="mi">38</span> <span class="k">then</span> <span class="nx">moveCurrentNode</span> <span class="kc">true</span> <span class="c1"># up</span>
        <span class="k">when</span> <span class="mi">39</span> <span class="k">then</span> <span class="nx">setCurrentNodeExpanded</span> <span class="kc">true</span> <span class="c1"># right</span>
        <span class="k">when</span> <span class="mi">40</span> <span class="k">then</span> <span class="nx">moveCurrentNode</span> <span class="kc">false</span> <span class="c1"># down</span>
        <span class="k">else</span> <span class="k">return</span>

      <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>searching</p></div></div><div class="code"><div class="wrapper">  <span class="nx">search$</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&#39;keyup search&#39;</span><span class="p">,</span> <span class="nf">(evt) -&gt;</span>
    <span class="nx">searchNodes</span> <span class="nx">search$</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>

  <span class="nx">search$</span><span class="p">.</span><span class="nx">keydown</span> <span class="nf">(evt) -&gt;</span>
    <span class="k">if</span> <span class="nx">evt</span><span class="p">.</span><span class="nx">keyCode</span> <span class="o">==</span> <span class="mi">27</span> <span class="c1"># Esc</span>
      <span class="k">if</span> <span class="nx">search$</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">trim</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
        <span class="nx">search$</span><span class="p">.</span><span class="nx">blur</span><span class="p">()</span>
      <span class="k">else</span>
        <span class="nx">search$</span><span class="p">.</span><span class="nx">val</span> <span class="s">&#39;&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Make folded code blocks toggleable; the marker and the code are clickable.</p></div></div><div class="code"><div class="wrapper">  <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.code.folded&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(index, code) -&gt;</span>
    <span class="nv">code$ = </span><span class="nx">$</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span>
    <span class="nx">code$</span><span class="p">.</span><span class="nx">click</span> <span class="nf">(evt) -&gt;</span>
      <span class="nx">code$</span><span class="p">.</span><span class="nx">toggleClass</span> <span class="s">&#39;folded&#39;</span>
      <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
      <span class="k">return</span> <span class="kc">false</span></div></div></div></div></body></html>